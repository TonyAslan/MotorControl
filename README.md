# åŸºäºŽESP32S3çš„ç›´æµç”µæœºæŽ§åˆ¶
å®žçŽ°äº†ç›´æµç”µæœºçš„é€Ÿåº¦é—­çŽ¯æŽ§åˆ¶ï¼Œä¸Šä½æœºä½¿ç”¨å¾®ä¿¡å°ç¨‹åºï¼Œé€šè¿‡BLEé€šä¿¡

# é—­çŽ¯è°ƒé€Ÿçš„å®žçŽ°
å†™åœ¨å®šæ—¶å™¨ä¸­æ–­å‡½æ•°ï¼Œå³timer0_IRQ
1. ç¼–ç å™¨è„‰å†²è½¬è§’åº¦
double angle = en_cnt * 360.0/3120;
en_cnt æ˜¯ç¼–ç å™¨ç´¯è®¡è„‰å†²æ•°ã€‚
ç”µæœºä¸€åœˆä¼šäº§ç”Ÿ 3120 ä¸ªè„‰å†²ï¼ˆå·²ç»è€ƒè™‘äº†å‡é€Ÿæ¯”ï¼‰ã€‚
å› æ­¤è„‰å†²æ•° â†’ è§’åº¦ï¼š
ðœƒ = è„‰å†²æ•° / (è„‰å†²/åœˆ) Ã— 360Â°

2. å½“å‰é€Ÿåº¦è®¡ç®—
currentSpeed = (en_cnt - en_lastcnt)* 1000.0 * 60 / 3120 / 50;
å®šæ—¶å™¨50msè§¦å‘ä¸€æ¬¡ï¼Œå³ 20Hz é‡‡æ ·ã€‚
(en_cnt - en_lastcnt) = è¿‡åŽ» 50ms çš„è„‰å†²å¢žé‡ã€‚
é™¤ä»¥ 3120 = æ¢ç®—æˆç”µæœºè½¬æ•°ã€‚
é™¤ä»¥ 50ms = æ¢ç®—æˆè½¬/æ¯«ç§’ï¼Œå† Ã—1000 â†’ è½¬/ç§’ã€‚
å† Ã—60 â†’ è½¬/åˆ†é’Ÿ (RPM)ã€‚
æœ€ç»ˆå¾—åˆ°çš„æ˜¯ç”µæœºå½“å‰çš„è½¬é€Ÿï¼ˆRPMï¼‰ã€‚

3. è¯¯å·®è®¡ç®—
speedError = targetSpeed - currentSpeed;
targetSpeed = ç›®æ ‡è½¬é€Ÿï¼ˆè®¾å®šå€¼ï¼‰ã€‚
currentSpeed = å®žé™…è½¬é€Ÿï¼ˆæµ‹é‡å€¼ï¼‰ã€‚
ä¸¤è€…å·®å€¼å°±æ˜¯é€Ÿåº¦è¯¯å·®ã€‚

4. PID ä¸‰é¡¹è®¡ç®—
ç§¯åˆ†é¡¹
speedErrorIntegral += (speedError * 0.05); // 0.05s
æ¯æ¬¡ç´¯åŠ è¯¯å·® Ã— æ—¶é—´é—´éš”ï¼ˆ0.05sï¼‰ã€‚
ç§¯åˆ†èƒ½æ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼Œè®©ç”µæœºæœ€ç»ˆé€Ÿåº¦æ›´æŽ¥è¿‘ç›®æ ‡ã€‚

å¾®åˆ†é¡¹
speedErrorDifferential = (speedError - lastSpeedError) / 0.05;
è¯¯å·®çš„å˜åŒ–çŽ‡ã€‚
å¾®åˆ†èƒ½é¢„æµ‹è¶‹åŠ¿ï¼Œé¿å…è¶…è°ƒã€‚

PID æ€»å’Œ
double pidOutput = (kp*speedError) + (ki*speedErrorIntegral) + (kd*speedErrorDifferential);

kp æ¯”ä¾‹ï¼šå¿«é€Ÿå“åº”ã€‚
ki ç§¯åˆ†ï¼šæ¶ˆé™¤åå·®ã€‚
kd å¾®åˆ†ï¼šæŠ‘åˆ¶éœ‡è¡ã€‚

ä¸‰é¡¹ç›¸åŠ å¾—åˆ° PID è¾“å‡ºã€‚

5. PWM é™å¹… + è¾“å‡º
pwmOutput = pidOutput;
if(pidOutput > 255) pwmOutput = 255;
if(pidOutput < -255) pwmOutput = -255;

PWM è¾“å‡ºèŒƒå›´ï¼š-255 ~ 255ã€‚
å¤§äºŽ 255 â†’ é¥±å’Œä¿æŠ¤ã€‚
å°äºŽ -255 â†’ åæ–¹å‘é¥±å’Œã€‚

æ–¹å‘æŽ§åˆ¶ï¼š
if(pwmOutput > 0)
    motor.setSpeed(1, pwmOutput); // æ­£è½¬
else if(pwmOutput < 0)
    motor.setSpeed(0, -pwmOutput); // åè½¬
    
6. çŠ¶æ€æ›´æ–°
en_lastcnt = en_cnt;
lastSpeedError = speedError;
ä¿å­˜å½“å‰è®¡æ•°å’Œè¯¯å·®ï¼Œç»™ä¸‹ä¸€æ¬¡å®šæ—¶å™¨ä¸­æ–­ç”¨ã€‚

é€Ÿåº¦é—­çŽ¯ PID æŽ§åˆ¶å™¨ï¼š
é‡‡é›†åé¦ˆï¼šç¼–ç å™¨è„‰å†² â†’ è§’åº¦ã€è½¬é€Ÿã€‚
è®¡ç®—è¯¯å·®ï¼šç›®æ ‡é€Ÿåº¦ âˆ’ å®žé™…é€Ÿåº¦ã€‚
PID è°ƒèŠ‚ï¼šæ¯”ä¾‹ + ç§¯åˆ† + å¾®åˆ†ã€‚
è¾“å‡ºæŽ§åˆ¶ï¼šç”Ÿæˆ PWMï¼Œé©±åŠ¨ç”µæœºæ­£åè½¬ã€‚
å¾ªçŽ¯æ‰§è¡Œï¼šæ¯ 50ms æ›´æ–°ä¸€æ¬¡ã€‚
è¿™æ ·ï¼Œç”µæœºå°±èƒ½æŒ‰ç…§ç›®æ ‡é€Ÿåº¦è¿è¡Œï¼Œå¹¶ä¸”å³ä½¿æœ‰è´Ÿè½½å˜åŒ–ï¼ŒPID ä¹Ÿèƒ½è‡ªåŠ¨è°ƒæ•´ PWM æ¥ä¿æŒé€Ÿåº¦ã€‚
